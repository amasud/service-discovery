<!-- HTML TEMPLATE - v4.2: All feedback incorporated -->
<!-- CHANGES:
  1. Configure: More incident filters (state, priority), KB filter, Catalog filter
  2. Configure: On complete → goes to registry
  3. Registry: Run selector prompt + Edit button
  4. Dashboard: Larger/consistent fonts, facet fix, trend at topic level
  5. Dashboard: Company - Product on one line
  6. Dashboard: Supply modal shows both KB + Catalog gaps separately
  7. Dashboard: Summary stats computed from displayed data
-->
<div class="sd-wrapper">

  <!-- ═══════════ HOME ═══════════════════════════════════ -->
  <div ng-if="c.view === 'home'" class="sd-home">
    <div class="sd-hero">
      <div class="sd-hero-badge">
        <span class="sd-dot"></span>
        <span>{{c.data.catCount}} service opportunities &middot; {{c.data.totalTopics}} topics identified</span>
      </div>
      <h1 class="sd-hero-title">Service Discovery</h1>
      <p class="sd-hero-sub">Find what employees need. See what's covered. Build what's missing.</p>
      <div class="sd-hero-actions">
        <button class="sd-btn-white" ng-click="c.setView('dashboard')">View Opportunities &rarr;</button>
        <button class="sd-btn-ghost" ng-click="c.setView('configure')">+ New Run</button>
      </div>
    </div>
    <div class="sd-stats-bar">
      <div class="sd-stats-grid">
        <div class="sd-stat"><div class="sd-stat-value">{{c.data.catCount}}</div><div class="sd-stat-label">Opportunities</div></div>
        <div class="sd-stat"><div class="sd-stat-value">{{c.data.totalTopics}}</div><div class="sd-stat-label">Topics</div></div>
        <div class="sd-stat"><div class="sd-stat-value sd-stat-red">{{c.data.totalGaps}}</div><div class="sd-stat-label">Gaps</div></div>
        <div class="sd-stat"><div class="sd-stat-value" ng-class="{'sd-stat-red': c.data.coverPct < 50, 'sd-stat-green': c.data.coverPct >= 50}">{{c.data.coverPct}}%</div><div class="sd-stat-label">Coverage</div></div>
      </div>
    </div>
    <div class="sd-home-cards">
      <h2 class="sd-home-section-title">Quick Access</h2>
      <div class="sd-card-grid">
        <div class="sd-quick-card" ng-click="c.setView('configure')"><span class="sd-quick-icon">+</span><span class="sd-quick-label">New Run</span></div>
        <div class="sd-quick-card" ng-click="c.setView('registry')"><span class="sd-quick-icon">&#9678;</span><span class="sd-quick-label">Product Registry</span></div>
        <div class="sd-quick-card" ng-click="c.setView('dashboard')"><span class="sd-quick-icon">&#9673;</span><span class="sd-quick-label">Dashboard</span></div>
      </div>
      <h2 class="sd-home-section-title" ng-if="c.data.runs.length > 0">Recent Runs</h2>
      <div class="sd-run-card" ng-repeat="run in c.data.runs" ng-click="c.openRun(run)">
        <div>
          <div class="sd-run-name">{{run.name}}</div>
          <div class="sd-run-meta">
            <span>{{run.date}}</span>
            <span class="sd-run-pill" ng-class="{'sd-run-complete': run.status === 'Complete', 'sd-run-processing': run.status === 'Processing'}">{{run.status}}</span>
            <span>{{run.totalAnalyzed}} records</span>
            <span ng-if="run.gapsFound > 0" class="text-red">{{run.gapsFound}} gaps</span>
          </div>
        </div>
        <span class="sd-run-arrow">&rarr;</span>
      </div>
      <div class="sd-no-runs" ng-if="c.data.runs.length === 0">
        <p class="sd-no-runs-text">No analysis runs yet. <a class="sd-link" ng-click="c.setView('configure')">Create your first run &rarr;</a></p>
      </div>
    </div>
  </div>

  <!-- ═══════════ NEW RUN ════════════════════════════════ -->
  <div ng-if="c.view === 'configure'" class="sd-configure">
    <button class="sd-back-link" ng-click="c.setView('home')">&larr; Back</button>
    <h1 class="sd-page-title">New Analysis Run</h1>
    <p class="sd-page-desc">Select sources and filters. Incidents = demand. KB + catalog = supply.</p>

    <!-- Incidents source -->
    <div class="sd-source-card" ng-class="{'active': c.runSources.incidents}">
      <div class="sd-source-header" ng-click="c.toggleSource('incidents')">
        <div class="sd-source-left"><div class="sd-checkbox" ng-class="{'checked': c.runSources.incidents}"><span ng-if="c.runSources.incidents">&#10003;</span></div><div><div class="sd-source-name">Incidents</div><div class="sd-source-desc">Demand &mdash; what employees are asking for</div></div></div>
        <span class="sd-source-table">incident</span>
      </div>
      <div class="sd-source-body" ng-if="c.runSources.incidents">
        <div class="sd-filter-grid">
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Date Range</label>
            <select class="sd-input sd-select" ng-model="c.runFilters.dateRange">
              <option value="7">Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="180">Last 6 months</option>
              <option value="365">Last 12 months</option>
            </select>
          </div>
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Assignment Group</label>
            <input type="text" class="sd-input" ng-model="c.runFilters.assignmentGroup" placeholder="e.g., Service Desk">
          </div>
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Category</label>
            <input type="text" class="sd-input" ng-model="c.runFilters.category" placeholder="e.g., Hardware, Software">
          </div>
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">State</label>
            <select class="sd-input sd-select" ng-model="c.runFilters.state">
              <option value="">All states</option>
              <option value="closed">Closed</option>
              <option value="resolved">Resolved</option>
              <option value="open">Open</option>
            </select>
          </div>
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Priority</label>
            <select class="sd-input sd-select" ng-model="c.runFilters.priority">
              <option value="">All priorities</option>
              <option value="1">1 - Critical</option>
              <option value="2">2 - High</option>
              <option value="3">3 - Moderate</option>
              <option value="4">4 - Low</option>
            </select>
          </div>
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Record Limit</label>
            <select class="sd-input sd-select" ng-model="c.runFilters.limit">
              <option value="50">50 records</option>
              <option value="100">100 records</option>
              <option value="250">250 records</option>
              <option value="500">500 records</option>
              <option value="1000">1,000 records</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- KB source -->
    <div class="sd-source-card" ng-class="{'active': c.runSources.kb}">
      <div class="sd-source-header" ng-click="c.toggleSource('kb')">
        <div class="sd-source-left"><div class="sd-checkbox" ng-class="{'checked': c.runSources.kb}"><span ng-if="c.runSources.kb">&#10003;</span></div><div><div class="sd-source-name">KB Articles</div><div class="sd-source-desc">Supply &mdash; what's already documented</div></div></div>
        <span class="sd-source-table">kb_knowledge</span>
      </div>
      <div class="sd-source-body" ng-if="c.runSources.kb">
        <div class="sd-filter-grid">
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Knowledge Base</label>
            <input type="text" class="sd-input" ng-model="c.runFilters.kbName" placeholder="e.g., IT Knowledge Base">
          </div>
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Workflow State</label>
            <select class="sd-input sd-select" ng-model="c.runFilters.kbState">
              <option value="published">Published only</option>
              <option value="">All states</option>
              <option value="draft">Draft</option>
              <option value="review">In Review</option>
            </select>
          </div>
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Category</label>
            <input type="text" class="sd-input" ng-model="c.runFilters.kbCategory" placeholder="e.g., How To, FAQ">
          </div>
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Record Limit</label>
            <select class="sd-input sd-select" ng-model="c.runFilters.kbLimit">
              <option value="50">50 articles</option>
              <option value="100">100 articles</option>
              <option value="250">250 articles</option>
              <option value="500">500 articles</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Catalog source -->
    <div class="sd-source-card" ng-class="{'active': c.runSources.catalog}">
      <div class="sd-source-header" ng-click="c.toggleSource('catalog')">
        <div class="sd-source-left"><div class="sd-checkbox" ng-class="{'checked': c.runSources.catalog}"><span ng-if="c.runSources.catalog">&#10003;</span></div><div><div class="sd-source-name">Catalog Items</div><div class="sd-source-desc">Supply &mdash; what employees can request</div></div></div>
        <span class="sd-source-table">sc_cat_item</span>
      </div>
      <div class="sd-source-body" ng-if="c.runSources.catalog">
        <div class="sd-filter-grid">
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Catalog</label>
            <input type="text" class="sd-input" ng-model="c.runFilters.catalogName" placeholder="e.g., Service Catalog">
          </div>
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Category</label>
            <input type="text" class="sd-input" ng-model="c.runFilters.catalogCategory" placeholder="e.g., Hardware, Software">
          </div>
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Active Only</label>
            <select class="sd-input sd-select" ng-model="c.runFilters.catalogActive">
              <option value="true">Active only</option>
              <option value="">All items</option>
            </select>
          </div>
          <div class="sd-filter-field">
            <label class="sd-filter-label-sm">Record Limit</label>
            <select class="sd-input sd-select" ng-model="c.runFilters.catalogLimit">
              <option value="50">50 items</option>
              <option value="100">100 items</option>
              <option value="250">250 items</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Run config -->
    <div ng-if="c.hasAnySources()">
      <div class="sd-card sd-source-summary">
        <span><strong>{{c.getSourceCount()}}</strong> source{{c.getSourceCount() !== 1 ? 's' : ''}} selected</span>
        <div class="sd-source-pills">
          <span class="sd-pill-sm" ng-if="c.runSources.incidents">Incidents</span>
          <span class="sd-pill-sm" ng-if="c.runSources.kb">KB</span>
          <span class="sd-pill-sm" ng-if="c.runSources.catalog">Catalog</span>
        </div>
      </div>
      <div class="sd-card" style="margin-bottom: 16px;">
        <label class="sd-filter-label">Give it a name</label>
        <input type="text" class="sd-input" ng-model="c.runName" placeholder="e.g., Jan 16 &mdash; full analysis">
      </div>
      <button class="sd-btn-navy sd-btn-full" ng-if="!c.running" ng-click="c.startRun()">Classify Records</button>
      <div class="sd-card sd-progress-card" ng-if="c.running">
        <div class="sd-progress-header">
          <span class="sd-progress-label">
            <span ng-if="c.runPhase === 'creating'">Creating run...</span>
            <span ng-if="c.runPhase === 'classifying'">Classifying records...</span>
            <span ng-if="c.runPhase === 'extracting'">Extracting products...</span>
            <span ng-if="c.runPhase === 'matching'">Matching to registry...</span>
            <span ng-if="c.runPhase === 'error'" class="text-red">Error occurred. Please try again.</span>
          </span>
          <span class="sd-progress-pct">{{c.progress | number:0}}%</span>
        </div>
        <div class="sd-progress-bar"><div class="sd-progress-fill" ng-style="{'width': c.progress + '%'}"></div></div>
      </div>
    </div>
  </div>

  <!-- ═══════════ REGISTRY ═══════════════════════════════ -->
  <div ng-if="c.view === 'registry'" class="sd-registry">
    <button class="sd-back-link" ng-click="c.setView('home')">&larr; Home</button>
    <h1 class="sd-page-title">Product Registry</h1>
    <p class="sd-page-desc">Products extracted from your data, grouped by company.</p>

    <!-- v4.2: Run context banner -->
    <div class="sd-card sd-run-context" ng-if="c.getSelectedRun()">
      <div class="sd-run-context-inner">
        <span class="sd-modal-label">Viewing products from</span>
        <strong>{{c.getSelectedRun().name}}</strong>
        <span class="sd-run-meta-inline">{{c.getSelectedRun().date}} &middot; {{c.getSelectedRun().totalAnalyzed}} records</span>
      </div>
    </div>

    <div class="sd-tabs">
      <button class="sd-tab" ng-class="{'active': c.regTab === 'registry'}" ng-click="c.setRegTab('registry')">Registry ({{c.data.companyList.length}})</button>
      <button class="sd-tab" ng-class="{'active': c.regTab === 'unmatched'}" ng-click="c.setRegTab('unmatched')">Unmatched</button>
    </div>
    <div ng-if="c.regTab === 'registry'">
      <div class="sd-card sd-summary" style="margin-bottom: 20px;">
        <p class="sd-summary-text"><strong>{{c.data.companyList.length}} companies</strong> and <strong>{{c.data.registry.length}} products</strong> identified.</p>
      </div>
      <div class="sd-reg-card" ng-repeat="co in c.data.companyList track by $index" ng-class="{'confirmed': co.confirmed}">
        <div class="sd-reg-card-main">
          <div class="sd-reg-left">
            <div class="sd-reg-status" ng-class="{'done': co.confirmed}">{{co.confirmed ? '&#10003;' : '?'}}</div>
            <div>
              <div class="sd-reg-company">{{co.name}}</div>
              <div class="sd-reg-products"><span class="sd-pill-sm" ng-repeat="p in co.products">{{p}}</span></div>
            </div>
          </div>
          <div class="sd-reg-right">
            <span class="sd-reg-mentions">{{co.totalMentions}} mentions</span>
            <!-- v4.2: Edit button -->
            <button class="sd-btn-sm sd-btn-edit" ng-click="c.editCompany($index)">Edit</button>
            <button class="sd-btn-sm sd-btn-confirm" ng-if="!co.confirmed" ng-click="c.confirmCompany($index)">Confirm</button>
            <button class="sd-btn-sm sd-btn-remove" ng-click="c.removeCompany($index)">&times;</button>
          </div>
        </div>
        <!-- v4.2: Inline edit form -->
        <div class="sd-reg-edit-form" ng-if="co.editing">
          <div class="sd-edit-grid" style="margin-top: 12px;">
            <div><label>Company Name</label><input type="text" class="sd-input" ng-model="co.editName"></div>
            <div><label>Products (comma-separated)</label><input type="text" class="sd-input" ng-model="co.editProducts"></div>
          </div>
          <div style="margin-top: 12px;">
            <button class="sd-btn-navy sd-btn-sm" ng-click="c.saveCompanyEdit($index)">Save</button>
            <button class="sd-btn-sm" ng-click="co.editing = false">Cancel</button>
          </div>
        </div>
      </div>
      <button class="sd-add-company-btn" ng-if="!c.showAddCompany" ng-click="c.toggleAddCompany()">+ Add Company</button>
      <div class="sd-card sd-add-form" ng-if="c.showAddCompany">
        <strong>Add a new company</strong>
        <div class="sd-edit-grid" style="margin-top: 12px;">
          <div><label>Company</label><input type="text" class="sd-input" ng-model="c.newCompany" placeholder="e.g., Zoom"></div>
          <div><label>Products</label><input type="text" class="sd-input" ng-model="c.newProducts" placeholder="Comma-separated"></div>
          <div><label>Owner</label><input type="text" class="sd-input" ng-model="c.newOwner" placeholder="Optional"></div>
        </div>
        <div style="margin-top: 12px;"><button class="sd-btn-navy sd-btn-sm" ng-click="c.addCompany()">Add</button> <button class="sd-btn-sm" ng-click="c.toggleAddCompany()">Cancel</button></div>
      </div>
      <div class="sd-reg-actions">
        <button class="sd-btn-outline" ng-click="c.confirmAll()">Confirm All</button>
        <button class="sd-btn-navy sd-btn-flex" ng-click="c.setView('dashboard')">Save Registry &amp; View Results &rarr;</button>
      </div>
    </div>
    <div ng-if="c.regTab === 'unmatched'">
      <div class="sd-card sd-unmatched-summary"><p class="sd-summary-text">No unmatched products yet. Run a classification to discover new products.</p></div>
    </div>
  </div>

  <!-- ═══════════ DASHBOARD ══════════════════════════════ -->
  <div ng-if="c.view === 'dashboard'" class="sd-dashboard">
    <div class="sd-header">
      <div class="sd-header-left">
        <button class="sd-back-link" ng-click="c.setView('home')">&larr; Home</button>
        <h1 class="sd-page-title" style="margin-top: 8px;">Service Opportunities</h1>
      </div>
      <div class="sd-header-right">
        <div class="sd-run-selector" ng-if="c.data.runs.length > 0">
          <select class="sd-input sd-select" ng-model="c.selectedRunId" ng-change="c.selectRun(c.selectedRunId)">
            <option value="">All runs (unfiltered)</option>
            <option ng-repeat="run in c.data.runs" value="{{run.sys_id}}">{{run.name}} ({{run.date}})</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Owner filter -->
    <div class="sd-card sd-filter-card">
      <label class="sd-filter-label">What do you own?</label>
      <div class="sd-filter-row">
        <div class="sd-filter-input-wrap">
          <input type="text" class="sd-input" ng-model="c.ownerFilter" ng-change="c.setOwnerFilter(c.ownerFilter)" ng-focus="c.showSuggestions = true" ng-blur="c.hideSuggestions()" placeholder="Type a company or product &mdash; e.g. Microsoft Teams, Cisco...">
          <div class="sd-suggestions" ng-if="c.showSuggestions &amp;&amp; c.getSuggestions().length > 0">
            <div class="sd-suggestion-item" ng-repeat="s in c.getSuggestions()" ng-mousedown="c.selectSuggestion(s)">{{s}}</div>
          </div>
        </div>
        <button class="sd-btn-outline" ng-if="c.ownerFilter" ng-click="c.clearFilter()">Clear</button>
      </div>
      <p class="sd-filter-hint" ng-if="c.ownerFilter">Showing topics involving <strong>{{c.ownerFilter}}</strong></p>
      <p class="sd-filter-hint">Powered by product registry &mdash; {{c.data.companyList.length}} companies. <a class="sd-link" ng-click="c.setView('registry')">Edit &rarr;</a></p>
    </div>

    <!-- v4.2: Summary uses live computed stats + facet toggle inline -->
    <div class="sd-summary-row">
      <div class="sd-card sd-summary sd-summary-inline" ng-init="liveStats = c.getLiveStats()">
        <p class="sd-summary-text" ng-if="!c.ownerFilter">
          We found <strong>{{liveStats.catCount}} service opportunities</strong> with <strong>{{liveStats.topics}} topics</strong>.
          Today, <strong class="text-green">{{liveStats.covered}} are covered</strong> &mdash;
          that's <strong ng-class="{'text-green': liveStats.pct >= 50, 'text-red': liveStats.pct < 50}">{{liveStats.pct}}% coverage</strong>.
          <span ng-if="liveStats.gaps > 0">To address the remaining <strong>{{liveStats.gaps}}</strong>, consider creating KB articles and catalog items.</span>
        </p>
        <p class="sd-summary-text" ng-if="c.ownerFilter" ng-init="fStats = c.getFilteredStats()">
          <strong>{{c.ownerFilter}}</strong> touches <strong>{{fStats.topics}} topics</strong> across <strong>{{fStats.catCount}} categories</strong>.
          Of those, <strong ng-class="{'text-red': fStats.gaps > 0, 'text-green': fStats.gaps === 0}">{{fStats.gaps}} have gaps</strong>.
        </p>
      </div>
      <div class="sd-facet-toggle">
        <button class="sd-facet-btn" ng-class="{'active': c.facet === 'gaps'}" ng-click="c.setFacet('gaps')">Gaps Only</button>
        <button class="sd-facet-btn" ng-class="{'active': c.facet === 'all'}" ng-click="c.setFacet('all')">All</button>
      </div>
    </div>

    <!-- Table -->
    <div class="sd-table">
      <div class="sd-table-header">
        <span class="sd-col-topics">Topics</span>
        <span class="sd-col-name">Service Opportunity</span>
        <span class="sd-col-records">Records</span>
        <span class="sd-col-trend">Trend</span>
        <span class="sd-col-gaps">Gaps</span>
        <span class="sd-col-coverage">Coverage</span>
      </div>
      <div class="sd-table-body">
        <div class="sd-empty" ng-if="c.getFilteredCategories().length === 0">
          <span ng-if="c.ownerFilter">No match for "{{c.ownerFilter}}"</span>
          <span ng-if="!c.ownerFilter">No results yet. <a class="sd-link" ng-click="c.setView('configure')">Run a classification first &rarr;</a></span>
        </div>

        <div ng-repeat="cat in c.getFilteredCategories() track by cat.sys_id">
          <!-- Category row -->
          <div class="sd-cat-row" ng-click="c.toggleCategory(cat.name)">
            <span class="sd-col-topics"><strong class="sd-topic-count">{{cat.topicCount}}</strong></span>
            <span class="sd-col-name">
              <span class="sd-arrow" ng-class="{'open': c.expanded[cat.name]}">&#9654;</span>
              <span class="sd-cat-info"><span class="sd-cat-name">{{cat.name}}</span><span class="sd-cat-pct">{{cat.pct}}% of volume</span></span>
            </span>
            <span class="sd-col-records sd-col-records-val">{{cat.records | number}}</span>
            <span class="sd-col-trend">
              <span ng-if="cat.trend > 0" class="sd-trend-up">&#9650; {{cat.trend}}%</span>
              <span ng-if="cat.trend < 0" class="sd-trend-down">&#9660; {{cat.trend * -1}}%</span>
              <span ng-if="cat.trend === 0" class="sd-trend-flat">&mdash;</span>
            </span>
            <span class="sd-col-gaps">
              <span class="sd-badge badge-red" ng-if="cat.gapCount > 0">{{cat.gapCount}} gap{{cat.gapCount !== 1 ? 's' : ''}}</span>
              <span class="sd-badge badge-green" ng-if="cat.gapCount === 0">None</span>
            </span>
            <span class="sd-col-coverage">
              <div class="sd-progress-bar"><div class="sd-progress-fill" ng-style="{'width': c.getCoveragePct(cat) + '%', 'background-color': c.getBarColor(c.getCoveragePct(cat))}"></div></div>
              <span class="sd-coverage-pct">{{c.getCoveragePct(cat)}}%</span>
            </span>
          </div>

          <!-- Expanded topics -->
          <div class="sd-expand-area" ng-if="c.expanded[cat.name]">
            <div class="sd-no-gaps" ng-if="c.getFilteredTopics(cat.topics).length === 0">No gaps in this category.</div>
            
            <div ng-repeat="topic in c.getFilteredTopics(cat.topics) track by topic.sys_id">
              <!-- Topic sub-header -->
              <div class="sd-topic-header">
                <span class="sd-col-topics"></span>
                <span class="sd-col-name sd-topic-header-name">
                  <span class="sd-topic-name-bold">{{topic.name}}</span>
                  <span class="sd-topic-solution">{{topic.solution}} &middot; {{topic.products.length > 0 ? topic.products.length : 'No'}} product{{topic.products.length !== 1 ? 's' : ''}} &middot; {{topic.volume}} records</span>
                </span>
                <span class="sd-col-records sd-col-records-val">
                  <a class="sd-link" ng-click="c.openDemandModal(topic); $event.stopPropagation()">{{topic.volume}}</a>
                </span>
                <!-- v4.2: Trend at topic level -->
                <span class="sd-col-trend">
                  <span ng-if="topic.trend > 0" class="sd-trend-up">&#9650; {{topic.trend}}%</span>
                  <span ng-if="topic.trend < 0" class="sd-trend-down">&#9660; {{topic.trend * -1}}%</span>
                  <span ng-if="!topic.trend || topic.trend === 0" class="sd-trend-flat">&mdash;</span>
                </span>
                <span class="sd-col-gaps">
                  <!-- v4.2: Show "Gaps" (plural) when both KB + Catalog -->
                  <span class="sd-badge badge-red" ng-if="topic.kbGap &amp;&amp; topic.catGap">Gaps</span>
                  <span class="sd-badge badge-red" ng-if="topic.kbGap &amp;&amp; !topic.catGap">KB Article</span>
                  <span class="sd-badge badge-red" ng-if="!topic.kbGap &amp;&amp; topic.catGap">Catalog Item</span>
                  <span class="sd-gap-dash" ng-if="!topic.kbGap &amp;&amp; !topic.catGap">&mdash;</span>
                </span>
                <span class="sd-col-coverage sd-coverage-link-col">
                  <a class="sd-link sd-link-red" ng-if="topic.kbGap || topic.catGap" ng-click="c.openSupplyModal(topic); $event.stopPropagation()">View gap{{topic.kbGap &amp;&amp; topic.catGap ? 's' : ''}} &rarr;</a>
                  <a class="sd-link sd-link-green" ng-if="!topic.kbGap &amp;&amp; !topic.catGap" ng-click="c.openSupplyModal(topic); $event.stopPropagation()">Covered &#10003;</a>
                </span>
              </div>

              <!-- v4.2: Product rows - Company - Product on one line -->
              <div class="sd-product-row" ng-repeat="prod in topic.products track by $index" ng-if="topic.products.length > 0">
                <span class="sd-col-topics"></span>
                <span class="sd-col-name sd-product-name-col">
                  <span class="sd-product-pill" ng-class="{'gap': prod.kbGap || prod.catGap, 'covered': !prod.kbGap &amp;&amp; !prod.catGap}">{{prod.company ? prod.company + ' - ' : ''}}{{prod.product}}</span>
                </span>
                <span class="sd-col-records sd-col-records-val">
                  <a class="sd-link" ng-click="c.openProductDemand(topic, prod); $event.stopPropagation()">{{prod.count}}</a>
                </span>
                <span class="sd-col-trend"></span>
                <span class="sd-col-gaps">
                  <span class="sd-badge badge-red" ng-if="prod.kbGap &amp;&amp; prod.catGap">Gaps</span>
                  <span class="sd-badge badge-red" ng-if="prod.kbGap &amp;&amp; !prod.catGap">KB Article</span>
                  <span class="sd-badge badge-red" ng-if="!prod.kbGap &amp;&amp; prod.catGap">Catalog Item</span>
                  <span class="sd-gap-dash" ng-if="!prod.kbGap &amp;&amp; !prod.catGap">&mdash;</span>
                </span>
                <span class="sd-col-coverage sd-coverage-link-col">
                  <a class="sd-link sd-link-red" ng-if="prod.kbGap || prod.catGap" ng-click="c.openProductSupply(topic, prod); $event.stopPropagation()">View gap{{prod.kbGap &amp;&amp; prod.catGap ? 's' : ''}} &rarr;</a>
                  <a class="sd-link sd-link-green" ng-if="!prod.kbGap &amp;&amp; !prod.catGap" ng-click="c.openProductSupply(topic, prod); $event.stopPropagation()">Covered &#10003;</a>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════ MODAL ══════════════════════════════════ -->
  <div class="sd-modal-overlay" ng-if="c.modal" ng-click="c.closeModal()">
    <div class="sd-modal" ng-click="$event.stopPropagation()">
      
      <!-- Demand Modal -->
      <div ng-if="c.modal.type === 'demand'">
        <div class="sd-modal-header">
          <span class="sd-modal-label">Demand Signal</span>
          <h2 class="sd-modal-title">{{c.modal.topic.name}}</h2>
          <div class="sd-modal-pills" ng-if="c.modal.product"><span class="sd-pill-sm">{{c.modal.product.company ? c.modal.product.company + ' - ' : ''}}{{c.modal.product.product}}</span></div>
          <button class="sd-modal-close" ng-click="c.closeModal()">&times;</button>
        </div>
        <div class="sd-modal-context">
          <p><strong>{{c.modal.incidents.length}} incidents</strong> matched
          <span ng-if="c.modal.product"> for <strong>{{c.modal.product.product}}</strong></span>.
          Below are examples with resolution notes.</p>
        </div>
        <div class="sd-modal-body">
          <div class="sd-modal-empty" ng-if="c.modal.incidents.length === 0">
            <p>No incident data available. Run a classification to populate.</p>
          </div>
          <div class="sd-modal-record" ng-repeat="inc in c.modal.incidents track by $index">
            <span class="sd-record-id">{{inc.id}}</span>
            <p class="sd-record-title">{{inc.title}}</p>
            <p class="sd-record-notes" ng-if="inc.close_notes">{{inc.close_notes}}</p>
          </div>
        </div>
      </div>

      <!-- v4.2: Supply Modal - shows both KB + Catalog gaps separately -->
      <div ng-if="c.modal.type === 'supply'">
        <div class="sd-modal-header">
          <span class="sd-modal-label">Current Coverage</span>
          <h2 class="sd-modal-title">{{c.modal.topic.name}}</h2>
          <div class="sd-modal-pills" ng-if="c.modal.product"><span class="sd-pill-sm">{{c.modal.product.company ? c.modal.product.company + ' - ' : ''}}{{c.modal.product.product}}</span></div>
          <button class="sd-modal-close" ng-click="c.closeModal()">&times;</button>
        </div>

        <!-- Both gaps -->
        <div ng-if="c.modal.isGap">
          <div class="sd-modal-context sd-modal-context-gap" ng-if="c.modal.topic.kbGap">
            <p><span class="sd-badge badge-red" style="margin-right: 6px;">KB Article</span>
            No KB article exists for this topic<span ng-if="c.modal.product"> involving <strong>{{c.modal.product.product}}</strong></span>.
            Employees cannot self-serve. <strong>Recommendation:</strong> Create a knowledge article covering resolution steps.</p>
          </div>
          <div class="sd-modal-context sd-modal-context-gap" ng-if="c.modal.topic.catGap" style="margin-top: 8px;">
            <p><span class="sd-badge badge-red" style="margin-right: 6px;">Catalog Item</span>
            No catalog item exists for this topic<span ng-if="c.modal.product"> involving <strong>{{c.modal.product.product}}</strong></span>.
            Employees cannot submit a structured request. <strong>Recommendation:</strong> Create a catalog item with appropriate fulfillment workflow.</p>
          </div>
          <div class="sd-modal-body" ng-if="c.modal.incidents.length > 0">
            <div class="sd-modal-patterns-header">
              <span class="sd-modal-label">How agents resolve this today</span>
              <p class="sd-modal-patterns-sub">From {{c.modal.incidents.length}} close notes</p>
            </div>
            <div class="sd-modal-record" ng-repeat="inc in c.modal.incidents track by $index">
              <span class="sd-record-id">{{inc.id}}</span>
              <p class="sd-record-title">{{inc.title}}</p>
              <p class="sd-record-notes" ng-if="inc.close_notes">{{inc.close_notes}}</p>
            </div>
          </div>
        </div>

        <!-- Covered -->
        <div class="sd-modal-context sd-modal-context-covered" ng-if="!c.modal.isGap">
          <p>This topic<span ng-if="c.modal.product"> for <strong>{{c.modal.product.product}}</strong></span> has coverage. No additional content needed.</p>
        </div>
      </div>
    </div>
  </div>

</div>
